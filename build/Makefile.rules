# Hobbit main Makefile
#
# This file is included from the Makefile created by the "configure" script



#####################
# Build targets
#####################

CFLAGS += -DMAXMSG=$(MAXMSG) -DBBDPORTNUMBER=$(BBPORT) -I. -I$(BUILDTOPDIR)/include

BUILDTARGETS = lib-build common-build bbdisplay-build bbnet-build bbproxy-build
INSTALLTARGETS = install-bbdisplay install-bbnet install-bbproxy
INSTALLNOCGITARGETS = install-bbdisplay-nocgi install-bbnet install-bbproxy
ifdef HOBBITD
	BUILDTARGETS += hobbitd-build
	INSTALLTARGETS += install-hobbitd
	INSTALLNOCGITARGETS += install-hobbitd
endif
BBHOMEDIRS = bin etc ext tmp web www www/gifs www/help www/html www/menu www/notes www/rep www/wml
BBVARDIRS = acks data disabled hist histlogs logs rrd

all: $(BUILDTARGETS)
	@echo ""
	@echo "Build complete."
	@echo "To setup a new Hobbit server from scratch, now run 'make setup' as root"
	@echo "To upgrade an existing Hobbit/BB server, now run 'make install' as root"
	@echo ""

lib-build:
	CC="$(CC)" CFLAGS="$(CFLAGS)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" $(MAKE) -C lib all

common-build: lib-build
	CC="$(CC)" CFLAGS="$(CFLAGS)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" $(MAKE) -C common all

bbdisplay-build: lib-build common-build
ifdef HOBBITD
	CC="$(CC)" CFLAGS="$(CFLAGS)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" BBVAR="$(BBVAR)" HISTGRAPHDEF="$(HISTGRAPHDEF)" HOBBITD="$(HOBBITD)" $(MAKE) -C bbdisplay all
else
	CC="$(CC)" CFLAGS="$(CFLAGS)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" HISTGRAPHDEF="$(HISTGRAPHDEF)" $(MAKE) -C bbdisplay all
endif


bbnet-build: lib-build common-build
	CC="$(CC)" CFLAGS="$(CFLAGS)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" LDAPFLAGS="$(LDAPFLAGS)" LDAPINCDIR="$(LDAPINCDIR)" LDAPLIBS="$(LDAPLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" $(MAKE) -C bbnet all

bbproxy-build: lib-build common-build
	CC="$(CC)" CFLAGS="$(CFLAGS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" $(MAKE) -C bbproxy all

hobbitd-build: lib-build common-build
	CC="$(CC)" CFLAGS="$(CFLAGS)" RRDINCDIR="$(RRDINCDIR)" PCREINCDIR="$(PCREINCDIR)" NETLIBS="$(NETLIBS)" RRDLIBS="$(RRDLIBS)" PCRELIBS="$(PCRELIBS)" BBTOPDIR="$(BBTOPDIR)" BBHOME="$(BBHOME)" BBVAR="$(BBVAR)" BBLOGDIR="$(BBLOGDIR)" BBHOSTNAME="$(BBHOSTNAME)" BBHOSTIP="$(BBHOSTIP)" BBHOSTOS="$(BBHOSTOS)" BBUSER="$(BBUSER)" CGIDIR="$(CGIDIR)" BBHOSTURL="$(BBHOSTURL)" BBCGIURL="$(BBCGIURL)" FPING="$(FPING)" $(MAKE) -C hobbitd  all


#####################
# Cleanup targets
#####################
distclean: allclean
	rm -f Makefile
	cd bbnet/c-ares-1.2.0 && ($(MAKE) distclean || /bin/true)

allclean: clean
	cd bbnet/c-ares-1.2.0 && ($(MAKE) clean || /bin/true)

clean:
	$(MAKE) -C lib clean
	$(MAKE) -C common clean
	$(MAKE) -C bbdisplay clean
	$(MAKE) -C bbnet clean
	$(MAKE) -C bbproxy clean
	$(MAKE) -C hobbitd clean
	rm -f ./*~ build/*~ include/*~


####################
# Install targets
####################

install: $(INSTALLTARGETS)
install-nocgi: $(INSTALLNOCGITARGETS)

install-dirs:
ifdef HOBBITD
	mkdir -p $(BBHOME) $(BBVAR)
	cd $(BBHOME); mkdir -p $(BBHOMEDIRS); chown $(BBUSER) $(BBHOMEDIRS); chgrp ` id -g $(BBUSER)` $(BBHOMEDIRS)
	cd $(BBVAR); mkdir -p $(BBVARDIRS); chown $(BBUSER) $(BBVARDIRS); chgrp ` id -g $(BBUSER)` $(BBVARDIRS)
ifdef HTTPDGID
	chgrp $(HTTPDGID) $(BBHOME)/www/rep
endif
	chmod g+w $(BBHOME)/www/rep
endif

install-common: install-dirs
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" $(MAKE) -C common install

install-bbdisplay: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" CGIDIR="$(CGIDIR)" HOBBITD="$(HOBBITD)" $(MAKE) -C bbdisplay install

install-bbdisplay-nocgi: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" CGIDIR="$(CGIDIR)" $(MAKE) -C bbdisplay install-nocgi

install-bbnet: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" $(MAKE) -C bbnet install

install-bbproxy: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" $(MAKE) -C bbproxy install

install-hobbitd: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" BBTOPDIR="$(BBTOPDIR)" BBHOME="$(BBHOME)" BBVAR="$(BBVAR)" CGIDIR="$(CGIDIR)" $(MAKE) -C hobbitd install

install-man:
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" $(MAKE) -C common install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" CGIDIR="$(CGIDIR)" $(MAKE) -C bbdisplay install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" $(MAKE) -C bbnet install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" $(MAKE) -C bbproxy install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" $(MAKE) -C hobbitd install-man

setup: install
	BBHOME="$(BBHOME)" BBVAR="$(BBVAR)" CGIDIR="$(CGIDIR)" BBLOGDIR="$(BBLOGDIR)" BBUSER="$(BBUSER)" $(MAKE) -C hobbitd  setup
	@echo ""
	@echo "Setup complete."
	@echo ""
	@echo "You must configure your webserver for the Hobbit webpages and CGI-scripts."
	@echo "A sample Apache configuration is in ${BBHOME}/etc/hobbit-apache.conf"
	@echo ""
	@echo "For availability reports, change the group-ID of ${BBHOME}/www/rep to your webservers group-ID"
	@echo ""
	@echo "To start Hobbit, as the $(BBUSER) user run '${BBHOME}/bin/starthobbit.sh start'"
	@echo "To view the Hobbit webpages, go to http://${BBHOSTNAME}${BBHOSTURL}"

