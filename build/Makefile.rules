# Hobbit main Makefile
#
# This file is included from the Makefile created by the "configure" script



#####################
# Build targets
#####################

CFLAGS += -DMAXMSG=$(MAXMSG) -DBBDPORTNUMBER=$(BBPORT) -I. -I$(BUILDTOPDIR)/include

BUILDTARGETS = lib-build common-build bbdisplay-build bbnet-build bbproxy-build docs-build build-build
INSTALLTARGETS = install-bbdisplay install-bbnet install-bbproxy install-man
INSTALLNOCGITARGETS = install-bbdisplay-nocgi install-bbnet install-bbproxy
ifdef HOBBITD
	BUILDTARGETS += hobbitd-build
	INSTALLTARGETS += install-hobbitd install-docs
	INSTALLNOCGITARGETS += install-hobbitd install-docs
endif

ARESVER = 1.2.1

IDTOOL := $(shell if test `uname -s` = "SunOS"; then echo /usr/xpg4/bin/id; else echo id; fi)

ifdef RPATH
RPATHOPT := $(RPATH)$(shell echo $(RPATHVAL) | sed -e 's/ / $(RPATH)/g')
endif

all: $(BUILDTARGETS)
	@echo ""
	@echo "Build complete. Now run '${MAKE} install' as root"
	@echo ""

build-build:
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" $(MAKE) -C build all

lib-build:
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBTOPDIR="$(BBTOPDIR)" BBLOGDIR="$(BBLOGDIR)" BBHOSTNAME="$(BBHOSTNAME)" BBHOSTIP="$(BBHOSTIP)" BBHOSTOS="$(BBHOSTOS)" $(MAKE) -C lib all

common-build: lib-build
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" $(MAKE) -C common all

bbdisplay-build: lib-build common-build
ifdef HOBBITD
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" BBVAR="$(BBVAR)" HISTGRAPHDEF="$(HISTGRAPHDEF)" HOBBITD="$(HOBBITD)" RUNTIMEDEFS="$(RUNTIMEDEFS)" PCREINCDIR="$(PCREINCDIR)" PCRELIBS="$(PCRELIBS)" $(MAKE) -C bbdisplay all
else
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" HISTGRAPHDEF="$(HISTGRAPHDEF)" RUNTIMEDEFS="$(RUNTIMEDEFS)" $(MAKE) -C bbdisplay all
endif


bbnet-build: lib-build common-build
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" SSLFLAGS="$(SSLFLAGS)" SSLINCDIR="$(SSLINCDIR)" SSLLIBS="$(SSLLIBS)" LDAPFLAGS="$(LDAPFLAGS)" LDAPINCDIR="$(LDAPINCDIR)" LDAPLIBS="$(LDAPLIBS)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" ARESVER="$(ARESVER)" RUNTIMEDEFS="$(RUNTIMEDEFS)" $(MAKE) -C bbnet all

bbproxy-build: lib-build common-build
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" NETLIBS="$(NETLIBS)" BBHOME="$(BBHOME)" $(MAKE) -C bbproxy all

hobbitd-build: build-build lib-build common-build 
	CC="$(CC)" CFLAGS="$(CFLAGS)" RPATHOPT="$(RPATHOPT)" RRDINCDIR="$(RRDINCDIR)" PCREINCDIR="$(PCREINCDIR)" NETLIBS="$(NETLIBS)" RRDLIBS="$(RRDLIBS)" PCRELIBS="$(PCRELIBS)" BBTOPDIR="$(BBTOPDIR)" BBHOME="$(BBHOME)" BBVAR="$(BBVAR)" BBLOGDIR="$(BBLOGDIR)" BBHOSTNAME="$(BBHOSTNAME)" BBHOSTIP="$(BBHOSTIP)" BBHOSTOS="$(BBHOSTOS)" BBUSER="$(BBUSER)" CGIDIR="$(CGIDIR)" SECURECGIDIR="$(SECURECGIDIR)" BBHOSTURL="$(BBHOSTURL)" BBCGIURL="$(BBCGIURL)" SECUREBBCGIURL="$(SECUREBBCGIURL)" FPING="$(FPING)" MAILPROGRAM="$(MAILPROGRAM)" RUNTIMEDEFS="$(RUNTIMEDEFS)" PERLBINARY="$(PERLBINARY)" $(MAKE) -C hobbitd  all

docs-build:
	BBHOSTURL="$(BBHOSTURL)" $(MAKE) -C docs all
	

#####################
# Cleanup targets
#####################
distclean: allclean
	rm -f Makefile
	rm -rf bbnet/c-ares

allclean: clean
	(cd bbnet/c-ares && $(MAKE) clean) || true

clean:
	$(MAKE) -C build clean
	$(MAKE) -C lib clean
	$(MAKE) -C common clean
	$(MAKE) -C bbdisplay clean
	$(MAKE) -C bbnet clean
	$(MAKE) -C bbproxy clean
	$(MAKE) -C hobbitd clean
	$(MAKE) -C docs clean
	rm -f ./*~ include/*~ debian/*~
	rm -f hobbit_*.dsc  hobbit_*.changes  hobbit_*.deb  hobbit_*.tar.gz


####################
# Install targets
####################

install: $(INSTALLTARGETS)
ifdef HOBBITD
	@echo ""
	@echo "Installation complete."
	@echo ""
	@echo "You must configure your webserver for the Hobbit webpages and CGI-scripts."
	@echo "A sample Apache configuration is in ${BBHOME}/etc/hobbit-apache.conf"
	@echo "If you have your Administration CGI scripts in a separate directory,"
	@echo "then you must also setup the password-file with the htpasswd command."
	@echo ""
	@echo "To start Hobbit, as the $(BBUSER) user run '${BBHOME}/bin/hobbit.sh start'"
	@echo "To view the Hobbit webpages, go to http://${BBHOSTNAME}${BBHOSTURL}"
endif

install-nocgi: $(INSTALLNOCGITARGETS)

ifndef INSTALLBINDIR
INSTALLBINDIR = $(BBHOME)/bin
endif
ifndef INSTALLETCDIR
INSTALLETCDIR = $(BBHOME)/etc
endif
ifndef INSTALLEXTDIR
INSTALLEXTDIR = $(BBHOME)/ext
endif
ifndef INSTALLTMPDIR
INSTALLTMPDIR = $(BBHOME)/tmp
endif
ifndef INSTALLWEBDIR
INSTALLWEBDIR = $(BBHOME)/web
endif
ifndef INSTALLWWWDIR
INSTALLWWWDIR = $(BBHOME)/www
endif


BBVARDIRS = acks data disabled hist histlogs logs rrd

install-dirs:
ifdef HOBBITD
	mkdir -p $(INSTALLROOT)$(BBHOME) $(INSTALLROOT)$(BBVAR)

	mkdir -p $(INSTALLROOT)$(INSTALLBINDIR)
	chown $(BBUSER) $(INSTALLROOT)$(INSTALLBINDIR)
	chgrp `$(IDTOOL) -g $(BBUSER)` $(INSTALLROOT)$(INSTALLBINDIR)
ifneq ($(INSTALLBINDIR),$(BBHOME)/bin)
	ln -sf $(INSTALLBINDIR) $(INSTALLROOT)$(BBHOME)/bin
endif

	mkdir -p $(INSTALLROOT)$(INSTALLETCDIR)
	chown $(BBUSER) $(INSTALLROOT)$(INSTALLETCDIR)
	chgrp `$(IDTOOL) -g $(BBUSER)` $(INSTALLROOT)$(INSTALLETCDIR)
ifneq ($(INSTALLETCDIR),$(BBHOME)/etc)
	ln -sf $(INSTALLETCDIR) $(INSTALLROOT)$(BBHOME)/etc
endif

	mkdir -p $(INSTALLROOT)$(INSTALLEXTDIR)
	chown $(BBUSER) $(INSTALLROOT)$(INSTALLEXTDIR)
	chgrp `$(IDTOOL) -g $(BBUSER)` $(INSTALLROOT)$(INSTALLEXTDIR)
ifneq ($(INSTALLEXTDIR),$(BBHOME)/ext)
	ln -sf $(INSTALLEXTDIR) $(INSTALLROOT)$(BBHOME)/ext
endif

	mkdir -p $(INSTALLROOT)$(INSTALLTMPDIR)
	chown $(BBUSER) $(INSTALLROOT)$(INSTALLTMPDIR)
	chgrp `$(IDTOOL) -g $(BBUSER)` $(INSTALLROOT)$(INSTALLTMPDIR)
ifneq ($(INSTALLTMPDIR),$(BBHOME)/tmp)
	ln -sf $(INSTALLTMPDIR) $(INSTALLROOT)$(BBHOME)/tmp
endif

	mkdir -p $(INSTALLROOT)$(INSTALLWEBDIR)
	chown $(BBUSER) $(INSTALLROOT)$(INSTALLWEBDIR)
	chgrp `$(IDTOOL) -g $(BBUSER)` $(INSTALLROOT)$(INSTALLWEBDIR)
ifneq ($(INSTALLWEBDIR),$(BBHOME)/web)
	ln -sf $(INSTALLWEBDIR) $(INSTALLROOT)$(BBHOME)/web
endif

	mkdir -p $(INSTALLROOT)$(INSTALLWWWDIR) $(INSTALLROOT)$(INSTALLWWWDIR)/gifs $(INSTALLROOT)$(INSTALLWWWDIR)/help $(INSTALLROOT)$(INSTALLWWWDIR)/html $(INSTALLROOT)$(INSTALLWWWDIR)/menu $(INSTALLROOT)$(INSTALLWWWDIR)/notes $(INSTALLROOT)$(INSTALLWWWDIR)/rep $(INSTALLROOT)$(INSTALLWWWDIR)/snap $(INSTALLROOT)$(INSTALLWWWDIR)/wml
	chown $(BBUSER) $(INSTALLROOT)$(INSTALLWWWDIR) $(INSTALLROOT)$(INSTALLWWWDIR)/gifs $(INSTALLROOT)$(INSTALLWWWDIR)/help $(INSTALLROOT)$(INSTALLWWWDIR)/html $(INSTALLROOT)$(INSTALLWWWDIR)/menu $(INSTALLROOT)$(INSTALLWWWDIR)/notes $(INSTALLROOT)$(INSTALLWWWDIR)/rep $(INSTALLROOT)$(INSTALLWWWDIR)/snap $(INSTALLROOT)$(INSTALLWWWDIR)/wml
	chgrp `$(IDTOOL) -g $(BBUSER)`  $(INSTALLROOT)$(INSTALLWWWDIR) $(INSTALLROOT)$(INSTALLWWWDIR)/gifs $(INSTALLROOT)$(INSTALLWWWDIR)/help $(INSTALLROOT)$(INSTALLWWWDIR)/html $(INSTALLROOT)$(INSTALLWWWDIR)/menu $(INSTALLROOT)$(INSTALLWWWDIR)/notes $(INSTALLROOT)$(INSTALLWWWDIR)/rep $(INSTALLROOT)$(INSTALLWWWDIR)/snap $(INSTALLROOT)$(INSTALLWWWDIR)/wml
ifneq ($(INSTALLWWWDIR),$(BBHOME)/www)
	ln -sf $(INSTALLWWWDIR) $(INSTALLROOT)$(BBHOME)/www
endif
ifdef HTTPDGID
	chgrp $(HTTPDGID) $(INSTALLROOT)$(INSTALLWWWDIR)/rep $(INSTALLROOT)$(INSTALLWWWDIR)/snap
endif
	chmod g+w $(INSTALLROOT)$(INSTALLWWWDIR)/rep $(INSTALLROOT)$(INSTALLWWWDIR)/snap

	cd $(INSTALLROOT)$(BBVAR); mkdir -p $(BBVARDIRS); chown $(BBUSER) $(BBVARDIRS); chgrp `$(IDTOOL) -g $(BBUSER)` $(BBVARDIRS)
endif

install-common: install-dirs
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" INSTALLROOT="$(INSTALLROOT)" INSTALLBINDIR="$(INSTALLBINDIR)" INSTALLETCDIR="$(INSTALLETCDIR)" INSTALLEXTDIR="$(INSTALLEXTDIR)" INSTALLTMPDIR="$(INSTALLTMPDIR)" INSTALLWEBDIR="$(INSTALLWEBDIR)" INSTALLWWWDIR="$(INSTALLWWWDIR)" $(MAKE) -C common install

install-bbdisplay: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" CGIDIR="$(CGIDIR)" SECURECGIDIR="$(SECURECGIDIR)" HOBBITD="$(HOBBITD)" INSTALLROOT="$(INSTALLROOT)" INSTALLBINDIR="$(INSTALLBINDIR)" INSTALLETCDIR="$(INSTALLETCDIR)" INSTALLEXTDIR="$(INSTALLEXTDIR)" INSTALLTMPDIR="$(INSTALLTMPDIR)" INSTALLWEBDIR="$(INSTALLWEBDIR)" INSTALLWWWDIR="$(INSTALLWWWDIR)" $(MAKE) -C bbdisplay install

install-bbdisplay-nocgi: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" CGIDIR="$(CGIDIR)" SECURECGIDIR="$(SECURECGIDIR)" INSTALLROOT="$(INSTALLROOT)" INSTALLBINDIR="$(INSTALLBINDIR)" INSTALLETCDIR="$(INSTALLETCDIR)" INSTALLEXTDIR="$(INSTALLEXTDIR)" INSTALLTMPDIR="$(INSTALLTMPDIR)" INSTALLWEBDIR="$(INSTALLWEBDIR)" INSTALLWWWDIR="$(INSTALLWWWDIR)" $(MAKE) -C bbdisplay install-nocgi

install-bbnet: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" ARESVER="$(ARESVER)" INSTALLROOT="$(INSTALLROOT)" INSTALLBINDIR="$(INSTALLBINDIR)" INSTALLETCDIR="$(INSTALLETCDIR)" INSTALLEXTDIR="$(INSTALLEXTDIR)" INSTALLTMPDIR="$(INSTALLTMPDIR)" INSTALLWEBDIR="$(INSTALLWEBDIR)" INSTALLWWWDIR="$(INSTALLWWWDIR)" $(MAKE) -C bbnet install

install-bbproxy: install-common
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" INSTALLROOT="$(INSTALLROOT)" INSTALLBINDIR="$(INSTALLBINDIR)" INSTALLETCDIR="$(INSTALLETCDIR)" INSTALLEXTDIR="$(INSTALLEXTDIR)" INSTALLTMPDIR="$(INSTALLTMPDIR)" INSTALLWEBDIR="$(INSTALLWEBDIR)" INSTALLWWWDIR="$(INSTALLWWWDIR)" $(MAKE) -C bbproxy install

install-hobbitd: install-common
	MANROOT="$(MANROOT)" BBTOPDIR="$(BBTOPDIR)" BBHOME="$(BBHOME)" BBVAR="$(BBVAR)" CGIDIR="$(CGIDIR)" SECURECGIDIR="$(SECURECGIDIR)" BBLOGDIR="$(BBLOGDIR)" BBUSER="$(BBUSER)" INSTALLROOT="$(INSTALLROOT)" INSTALLBINDIR="$(INSTALLBINDIR)" INSTALLETCDIR="$(INSTALLETCDIR)" INSTALLEXTDIR="$(INSTALLEXTDIR)" INSTALLTMPDIR="$(INSTALLTMPDIR)" INSTALLWEBDIR="$(INSTALLWEBDIR)" INSTALLWWWDIR="$(INSTALLWWWDIR)" $(MAKE) -C hobbitd install


# NOTE: This one is normally not used - man-page install is done by the sub-Makefiles during "make install"
install-man:
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" INSTALLROOT="$(INSTALLROOT)" $(MAKE) -C common install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" CGIDIR="$(CGIDIR)" SECURECGIDIR="$(SECURECGIDIR)" INSTALLROOT="$(INSTALLROOT)" $(MAKE) -C bbdisplay install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" INSTALLROOT="$(INSTALLROOT)" $(MAKE) -C bbnet install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" INSTALLROOT="$(INSTALLROOT)" $(MAKE) -C bbproxy install-man
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" INSTALLROOT="$(INSTALLROOT)" $(MAKE) -C hobbitd install-man

install-docs:
	BBHOME="$(BBHOME)" MANROOT="$(MANROOT)" INSTALLROOT="$(INSTALLROOT)" INSTALLBINDIR="$(INSTALLBINDIR)" INSTALLETCDIR="$(INSTALLETCDIR)" INSTALLEXTDIR="$(INSTALLEXTDIR)" INSTALLTMPDIR="$(INSTALLTMPDIR)" INSTALLWEBDIR="$(INSTALLWEBDIR)" INSTALLWWWDIR="$(INSTALLWWWDIR)" $(MAKE) -C docs install


